<!DOCTYPE html>
<html>

<head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div class="container">
        <ul class="comments">
            <!-- Здесь рендерятся комменты, если я всё напишу правильно -->
        </ul>
        <div class="add-form">
            <input id="input-name" type="text" class="add-form-name" placeholder="Введите ваше имя" />
            <textarea class="add-form-text" placeholder="Введите ваш комментарий" rows="4"></textarea>
            <div class="add-form-row">
                <button class="add-form-button">Написать</button>
            </div>
            <div class="del-form-row">
                <button class="del-form-button" style="margin-left: 10px;">Удалить последний комментарий</button>
            </div>
        </div>
    </div>
</body>

<script>
    "use strict";

    const inputNameElement = document.getElementById("input-name");
    const inputTextElement = document.querySelector(".add-form-text");
    const buttonElement = document.querySelector(".add-form-button");
    const buttonDelElement = document.querySelector(".del-form-button");
    const listElement = document.querySelector(".comments");
    const buttonsLikeElement = document.querySelectorAll(".like-button");

    const comments = [
        {
            name: "Глеб Фокин",
            date: "12.02.22 12:18",
            comment: "Это будет первый комментарий на этой странице",
            likes: true,
            likesCounter: 3
        },
        {
            name: "Варвара Н.",
            date: "13.02.22 19:22",
            comment: "Мне нравится как оформлена эта страница! ❤",
            likes: true,
            likesCounter: 75
        },
    ];

    buttonElement.disabled = true;

    document.addEventListener("input", () => {
        if (inputNameElement.value !== "" && inputTextElement.value !== "") {
            buttonElement.disabled = false;
        } else {
            buttonElement.disabled = true;
        }
    });

    const addNewComment = () => {
        const nameUser = inputNameElement.value;
        const textUser = inputTextElement.value;
        const oldListHtml = listElement.innerHTML;

        const currentDate = new Date();
        const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
        const date = currentDate.toLocaleDateString('ru-RU', options);

        let hour = currentDate.getHours();
        let minutes = currentDate.getMinutes();

        if (hour < 10 && hour > 0) {
            hour = "0" + hour;
        };

        if (minutes < 10) {
            minutes = "0" + minutes;
        };


        comments.push({
            name: nameUser,
            date: `${date} ${hour}:${minutes}`,
            comment: textUser,
            likes: false,
            likesCounter: 0
        });

        renderComments();

        inputNameElement.value = "";
        inputTextElement.value = "";
    };

    buttonElement.addEventListener("click", () => {
        addNewComment();
        buttonElement.disabled = true;
    })

    // после удаления последнего комментария, если добавить следующий коммент, удаленный коммент возвращается 

    buttonDelElement.addEventListener("click", () => {
        let commentsList = listElement.innerHTML;
        const indexLastListElement = commentsList.lastIndexOf('<li class="comment" data-index=');
        const lastComment = commentsList.slice(indexLastListElement);
        listElement.innerHTML = commentsList.replace(lastComment, '');
        // renderComments();
        
        return;
    });


    inputTextElement.addEventListener("keyup", (enter) => {

        if (enter.code === 'Enter' && inputNameElement.value !== "" && inputTextElement.value !== "") {
            addNewComment();
            buttonElement.disabled = true;
        }
    });

    inputNameElement.addEventListener("keyup", (enter) => {

        if (enter.code === 'Enter' && inputNameElement.value !== "" && inputTextElement.value !== "") {
            addNewComment();
            buttonElement.disabled = true;
        }
    })

    const initButtonLikeListeners = () => {
        const buttonsLikeElement = document.querySelectorAll(".like-button");

        for (const buttonLikeElement of buttonsLikeElement) {
            buttonLikeElement.addEventListener("click", (event) => {
                event.stopPropagation();

                const index = buttonLikeElement.dataset.index;
                if (!comments[index].likes) {
                    comments[index].likes = true;
                    comments[index].likesCounter += 1;

                } else {
                    comments[index].likes = false;
                    comments[index].likesCounter -= 1;
                }
                renderComments();
            })
        }
    };

    initButtonLikeListeners();

    const initButtonEditCommentListener = () => {
        const buttonsEditCommentElement = document.querySelectorAll(".button-edit-comment");

        for (const buttonEditCommentElement of buttonsEditCommentElement) {
            buttonEditCommentElement.addEventListener("click", (event) => {
                event.stopPropagation();
                const index = buttonEditCommentElement.dataset.index;

                if (buttonEditCommentElement.innerHTML === 'Редактировать') {
                    const commentElement = document.querySelectorAll('.comment-body')[index];

                    commentElement.innerHTML = `
            <div class="edit-form">
                <textarea class="edit-form-text" rows="4">${comments[index].comment}</textarea>
            </div>`;

                    buttonEditCommentElement.innerHTML = 'Сохранить';

                } else {
                    const inputTextElement = document.querySelector(".edit-form-text");

                    if (inputTextElement.value !== "") {
                        comments[index].comment = inputTextElement.value;
                        renderComments();
                    }
                }
            })
        }
    };

    initButtonEditCommentListener();

    //отправляет коммент в форму только один раз

    const initReplyCommentListener = () => {
        const commentsList = document.querySelectorAll('.comment');
        const inputTextElement = document.querySelector('.add-form-text');

        for (const comment of commentsList) {
            comment.addEventListener('click', () => {
                const index = comment.dataset.index;
                inputTextElement.value = `START_QUOTE ${comments[index].name}: ${comments[index].comment} END_QUOTE`;
            })
        }
    }

    initReplyCommentListener();


    const renderComments = () => {

        const commentsHTML = comments.map((comment, index) => {


            const safeName = comment.name
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;");

            const safeComment = comment.comment
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("START_QUOTE", '<div class="quote">').replaceAll("END_QUOTE", '</div>');



            return `<li class="comment" data-index="${index}">
                    <div class="comment-header">
                        <div>${safeName}</div>
                        <div>${comment.date}</div>
                    </div>
                    <div class="comment-body">
                        <div class="comment-text" data-index="${index}">
                            ${safeComment}
                        </div>
                    </div>
                    <div class="comment-footer">
                        <div class="likes">
                            <span class="likes-counter">${comment.likesCounter}</span>
                            <button data-index="${index}" class="like-button ${comment.likes ? '-active-like' : ''}"></button>
                        </div>
                    </div>
                        <div class="edit-form-row">
                            <button class="button-edit-comment" data-index="${index}">Редактировать</button>
                        </div>
                </li>`
        }).join("");

        listElement.innerHTML = commentsHTML;
        initReplyCommentListener();
        initButtonLikeListeners();
        initButtonEditCommentListener();

    };
    renderComments();

    console.log("It works!");


</script>

</html>